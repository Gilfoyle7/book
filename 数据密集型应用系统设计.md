### 第5章 数据复制



复制目的：

+ 使数据从地理位置上更接近用户，从而降低访问延迟
+ 当部分组件出现故障，系统仍然可以继续工作，提高可用性
+ 扩展至多台机器以同时提供数据访问服务，从而提高读吞吐量



PS：数据集是不断变化的，这是难点所在。本章基于数据无需分片的假设。

三种流行的复制数据变化的方法：主从复制、多主节点复制和无主节点复制





### 主节点与从节点

写请求将发送给主节点，从节点是只读的



#### 设计点1：同步复制与vs异步复制

![image-20210727174132652](/Users/wyy/Documents/notes/image-20210727174132652.png)

|      | 同步                                                         |
| ---- | ------------------------------------------------------------ |
| 优点 | 一旦向用户确认，从节点可以明确保证数据已处于最新版本。如果主节点发生故障，则可以在从节点继续访问最新数据。 |
| 缺点 | 如果同步的从节点无法完成确认（例如从节点发生崩溃，或者网络故障），写入就不能视为成功。主节点会阻塞其后所有的写操作，直到同步副本确认完成。 |

 **最佳实践**：

1. 半同步：设置其中某一个从节点是同步的，而其他节点则是异步模式。
2. 全异步： 个人理解这里会有一个消息队列来存储对从节点的写请求，所以如果主节点发生故障，则可能会丢失数据，这意味着即使向客户端确认了写操作，也无法保证数据的持久化。

PS：无论是同步还是异步，我们都在追求多副本的一致性，这个问题与共识有着密切的联系（即让多个节点对数据状态达成一致）



#### 设计点2：配置新的从节点

Why：增加新的副本数提高容错能力+替换失败的副本 -》需要配置新的从节点

How：MySQL的binlog



#### 设计点3：如何处理节点失效

Why：系统中的任何节点都可能因故障或者维护而导致中断甚至停机。我们希望在这种情况下仍要保持系统总体的持续运行。

+ 从节点失效：追赶式恢复

+ 主节点失效：节点切换

  + 确认主节点失效：**心跳机制**
  + 选举新的主节点：**共识问题**
  + 重新配置系统使新主节点生效

  需要考虑的一些点：

  + 如果采用之前所说的异步复制，那么主节点的失效将会带来数据的丢失。
  + 脑裂
  + 合适的超时

节点失效、网络不可靠、副本一致性、持久性、可用性与延迟之间各种细微的权衡，就是分布式系统核心的基本问题。



#### 复制日志的实现

1. 基于语句的复制
2. 基于预写日志传输
3. 基于行的逻辑日志复制(MySQL的binlog)
4. 基于触发器的复制



### 复制滞后的问题

1. 读自己的写

   需求：读写一致性

   实现：如果用户访问可能会被修改的内容，从主节点读取，否则在从节点读取；跟踪最近更新的时间，如果更新后一分钟之内，则总是在主节点读取；客户可以记住最近更新时的时间戳，并附带在读请求中。

2. 单调读

   需求：单调读一致性

   实现：每个用户总是从固定的同一副本执行读取。

3. 前缀一致读

   需求：前缀一致读

   解释：对于一系列按照某个顺序发生的写请求，那么读取这些内容时也会按照当时写入的顺序





